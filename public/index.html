<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Display a map</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.2.0/mapbox-gl-draw.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.2.0/mapbox-gl-draw.css" type="text/css" />
<script src="/js/ors.js"></script>
<style>
	body { margin: 0; padding: 0; }
	#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
<div id="map"></div>
<script>
	// TO MAKE THE MAP APPEAR YOU MUST
	// ADD YOUR ACCESS TOKEN FROM
	// https://account.mapbox.com
	mapboxgl.accessToken = 'pk.eyJ1IjoibWlyb3JhYyIsImEiOiJja2hocHplcGwwazV0MnlwOW83NGxzNTIxIn0.TQebKFe1OfUmhJzZ6SV45w';
  var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/mapbox/streets-v11', // style URL
    center: [17.154829, 48.160582], // starting position [lng, lat]
    zoom: 15 // starting zoom
  });

  const destination = [17.151429904825818, 48.1600897443393]
  const safetyRoutes = [
    //sever
    [[17.142135559291546,48.16178269617117],[17.142180399984852,48.16173318444612],[17.142213712402167,48.16169480376047],[17.14251352415667,48.16136452667283],[17.142699770852687,48.16115242100042],[17.14280425070541,48.16105343805293],[17.143036130322088,48.16078477241811],[17.143669542565107,48.160224975350644],[17.143916880512194,48.160338708966094],[17.143954219996942,48.16029949329436],[17.144234663368792,48.16000219513066],[17.14465810903056,48.15949715525821],[17.144767744118326,48.159371556944876],[17.144819383830736,48.15931326226922],[17.144908359680727,48.15921435529515],[17.144962730656147,48.15915246791201],[17.14505680107638,48.15904653956221],[17.145113976902337,48.15898206133198],[17.145456558139102,48.159123425269144],[17.145894595811285,48.15928018487426],[17.14659063202535,48.15955793056722],[17.14680763825737,48.159644556035715],[17.14745261034011,48.15989636603936],[17.147503460091883,48.159916086695716],[17.14775849720408,48.15999602100865],[17.148021023796332,48.16006964461539],[17.14822382544972,48.16011802721724],[17.14858162235919,48.16018500536677],[17.14887790079746,48.160240309448],[17.148879315014312,48.160239719852285],[17.14889699274039,48.16019090131775],[17.148905831609397,48.160167199547516],[17.148931817869567,48.15999692383002],[17.14897971240049,48.1596857967385],[17.149037841412365,48.159310550035485],[17.149074718964783,48.15908373292214],[17.14992915284475,48.159140437288784],[17.150644202126756,48.159188385784915],[17.15117111343855,48.15922340900846],[17.15205867460739,48.159277611566836],[17.152050549047914,48.15931430249924],[17.151990544914497,48.1596757901641],[17.15154176399588,48.15964326888303],[17.151476759517237,48.15968371200768],[17.15142300580834,48.16010106651109]],
    //vychod, astronomicka
    [[17.17705808018769,48.15878081933303],[17.176796030443626,48.1587606744971],[17.17658561131813,48.158745078489545],[17.176097555847377,48.15870803795221],[17.17511365161309,48.15863460662024],[17.174576888024518,48.15858846829926],[17.174176507189514,48.15855922568292],[17.173545249813372,48.15851373713491],[17.1734546526898,48.158508538440856],[17.172499973335675,48.15844030553038],[17.172486335059574,48.15844030553038],[17.171797602097996,48.158385069296145],[17.16837049804667,48.15813618059272],[17.166817682846414,48.15799971368938],[17.16650400248477,48.15799776415986],[17.16594970396858,48.15795617417305],[17.163757838090476,48.157789813901275],[17.16354081514686,48.1577540677217],[17.163363981632557,48.15772010882475],[17.163176430937312,48.15774155655177],[17.163104089953464,48.15772010882475],[17.163034428266485,48.157698661088716],[17.16283616038774,48.15768078796839],[17.16271827137942,48.157712959580266],[17.162627175326662,48.1576647021551],[17.162458379700325,48.15762001931341],[17.16201508707934,48.157709621970525],[17.161897071000283,48.1576987631465],[17.16186044532111,48.15769604844027],[17.160969220450966,48.157620036604925],[17.160057647980807,48.15756845708137],[17.15810834791742,48.157424577074295],[17.157721743521876,48.157400144582],[17.156793892971592,48.15732684703414],[17.156529374174852,48.15732956176052],[17.15649607538137,48.157518667441394],[17.15645692652967,48.15773380792294],[17.1564298929311,48.15792029783367],[17.15622317772167,48.15790296037471],[17.156056979735382,48.15788973805158],[17.15527463360084,48.15783049319057],[17.155256389544462,48.15790596912839],[17.155161264301256,48.158445213900535],[17.1550215282966,48.159323220350814],[17.15474056409971,48.159382855747396],[17.154384001256886,48.159591993578914],[17.1544014215161,48.1594557129678],[17.152057795478896,48.159277775885414],[17.15204949033881,48.15931347837949],[17.151991354362565,48.15967850417968],[17.15154103125414,48.15964341749077],[17.15147551293103,48.159684044175634],[17.1514229137328,48.160101389158996]],
    //trnavka
    [[17.16197313616206,48.16548271685144],[17.16201581993073,48.165448824840894],[17.162013787369602,48.16536883960606],[17.162011754809413,48.165176332258994],[17.16202598273162,48.16508007831419],[17.16208289441832,48.16499602542606],[17.162133708424562,48.16499466973323],[17.16212151306354,48.164830630631],[17.162495297443968,48.1648190536593],[17.162465612001228,48.16423297336948],[17.162447800699,48.16396765103346],[17.16238546126658,48.16293604892036],[17.162320153258094,48.16189650565238],[17.162286384625503,48.1613266204555],[17.162291001570992,48.16125394027071],[17.162328860540242,48.16107100748164],[17.162265369097696,48.16105901176135],[17.161858478770597,48.16107314778583],[17.16167004013397,48.161134077548496],[17.16110687359466,48.16108529135872],[17.161038123393638,48.1610755341151],[17.160975224274722,48.16105114099821],[17.16093572947861,48.16103260222138],[17.16087429312853,48.16099942755159],[17.161079080961258,48.160846238358005],[17.161143442850346,48.160745738192674],[17.16124157088325,48.1606600726748],[17.16139032795408,48.160160624978886],[17.16141760008378,48.16011266451409],[17.161328345841298,48.16007958830485],[17.161246529452086,48.160041550638454],[17.161157275209604,48.160010128196944],[17.16088951248338,48.159899322591485],[17.16020770922225,48.159851361871404],[17.159942425779235,48.159833169866744],[17.15968458019063,48.15981332403578],[17.159421776032076,48.15979678583733],[17.159173847581144,48.15977528617162],[17.158933356984647,48.159760401782535],[17.158826747750027,48.159755440318264],[17.15831849442617,48.15971740241116],[17.157818957856648,48.15968512665819],[17.15770488864365,48.15968021758343],[17.15629190226315,48.159574672370894],[17.156236707483004,48.15954030876665],[17.156258785395238,48.159412672320315],[17.15618133624426,48.15940527178404],[17.155979455362854,48.159392069159],[17.15530971801195,48.15934550180643],[17.15502052262491,48.15932402165603],[17.15474778404439,48.15938068227834],[17.15443767303364,48.159565258491256],[17.15438575942494,48.159596344947374],[17.15440938670767,48.159449233481666],[17.15439074344772,48.15944827686113],[17.15436110545042,48.15944604472824],[17.153871122426892,48.159408736204995],[17.153721360696125,48.159395665161924],[17.15346102718337,48.15937605858355],[17.153200693665497,48.15935551835727],[17.152943159436404,48.15933684541099],[17.152684225566134,48.15931817245837],[17.15244348706412,48.159300433152424],[17.15205438643676,48.159278025592215],[17.152047388224275,48.15931257057679],[17.151990002879472,48.15967762561374],[17.15154211726488,48.159643080874986],[17.151472135137595,48.15968509474311],[17.151421748028156,48.160100563370264]],
    //travniky
    [[17.158847647391184,48.15243154786154],[17.15882009157582,48.15262049309803],[17.158859894421596,48.15262662103973],[17.158945623627744,48.15263172765728],[17.15891194429645,48.15284211986682],[17.15885530179449,48.153193452511886],[17.158685374260045,48.154208626920536],[17.159130720744542,48.15424127175061],[17.15974787722405,48.15428750790531],[17.159667019824326,48.15492380123359],[17.15960117003786,48.15530564771112],[17.15953155708422,48.155709564040706],[17.159504606710357,48.15586495784382],[17.159471843355817,48.155879698371024],[17.159436032220242,48.15604819755447],[17.15940934471419,48.15631020605525],[17.159406410391597,48.15634805082507],[17.15939662931609,48.156449187573315],[17.159380979594545,48.15644853507888],[17.158647398922255,48.1564250452619],[17.1561698524348,48.15632782342624],[17.15612909763223,48.156551149048],[17.156120364467625,48.15659969796863],[17.156088342863143,48.156780299550036],[17.155773948928754,48.15675699615588],[17.155753571543528,48.156879338856925],[17.15574192727854,48.1569414810634],[17.155718638838465,48.15704828781557],[17.155706994619123,48.15710848788697],[17.15569826145466,48.157160920150005],[17.155404244905412,48.15713567499276],[17.155392600684763,48.15719781689535],[17.15527033637764,48.15783476705266],[17.155252870047264,48.157908559547536],[17.155159716278035,48.158450348558034],[17.155022896695385,48.15932418975163],[17.15474925753142,48.15938050345153],[17.154385375663452,48.15959216473544],[17.154402841992464,48.159450410027375],[17.152056531690107,48.159279527115814],[17.151989577427543,48.15967954757741],[17.151541274965297,48.15964459445749],[17.15146558753682,48.15969119861208],[17.151419010642087,48.16010286679918]],
  ]

  map.on('load', () => {
    map.addSource("safety", {
      type: "geojson",
      data: {
        type: "FeatureCollection",
        features: safetyRoutes.map(route => turf.lineString(route)),
      },
    })

    map.addLayer({
      'id': 'safety',
      'type': 'line',
      'source': 'safety',
      'layout': {
        'line-cap': 'round',
        'line-join': 'round'
      },
      'paint': {
        'line-color': '#4ed54b',
        'line-width': 10,
        'line-opacity': 0.5
      }
    })
  })

  let useSafety = true

  map.on('click', (e) => {
    const source = [e.lngLat.lng, e.lngLat.lat]

    if (useSafety) {

      getDistances({source, routes: safetyRoutes}, (data) => {
  
        let index = data.distances[0].indexOf(Math.min(...data.distances[0].slice(1)))

        let cursor = 1
        let route = safetyRoutes.map((route, index) => {
          let interval = [cursor, cursor+route.length, index]
          cursor += route.length
          return interval
        }).filter(interval => interval[0] <= index && interval[1] > index)[0]

        index = index-route[0]
        customRoute = safetyRoutes[route[2]][index]
  
        let params = {
          coordinates: [
            source,
            customRoute
          ]
        }
  
        getDirections(params, (data) => {
          const coords = data.features[0].geometry.coordinates
          geojson.features[0].geometry.coordinates = [...coords, ...safetyRoutes[route[2]].slice(index)]
          map.getSource('route').setData(geojson)
        })
  
      })

    } else {
      let params = {
        coordinates: [
          source,
          destination
        ]
      }

      getDirections(params, (data) => {
        const coords = data.features[0].geometry.coordinates
        geojson.features[0].geometry.coordinates = coords
        map.getSource('route').setData(geojson)
      })
    }


  })


  function x(source, destination, safetyRoutes) {
    
  }

</script>
 
<script src="/js/draw.js"></script>
<script src="/js/lines.js"></script>
<script src="/js/directions.js"></script>

<script>
  
</script>

</body>
</html>
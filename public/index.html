<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Display a map</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
<script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.tiles.mapbox.com/mapbox.js/plugins/turf/v3.0.11/turf.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.2.0/mapbox-gl-draw.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.2.0/mapbox-gl-draw.css" type="text/css" />
<script src="/js/ors.js"></script>
<style>
	body { margin: 0; padding: 0; }
	#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
<div id="map"></div>
<script>
	// TO MAKE THE MAP APPEAR YOU MUST
	// ADD YOUR ACCESS TOKEN FROM
	// https://account.mapbox.com
	mapboxgl.accessToken = 'pk.eyJ1IjoibWlyb3JhYyIsImEiOiJja2hocHplcGwwazV0MnlwOW83NGxzNTIxIn0.TQebKFe1OfUmhJzZ6SV45w';
  var map = new mapboxgl.Map({
    container: 'map', // container id
    style: 'mapbox://styles/mapbox/streets-v11', // style URL
    center: [17.154829, 48.160582], // starting position [lng, lat]
    zoom: 15 // starting zoom
  });

  const destination = [17.151429904825818, 48.1600897443393]
  const safetyRoutes = [
    //sever
    [[17.142135559291546,48.16178269617117],[17.142180399984852,48.16173318444612],[17.142213712402167,48.16169480376047],[17.14251352415667,48.16136452667283],[17.142699770852687,48.16115242100042],[17.14280425070541,48.16105343805293],[17.143036130322088,48.16078477241811],[17.143669542565107,48.160224975350644],[17.143916880512194,48.160338708966094],[17.143954219996942,48.16029949329436],[17.144234663368792,48.16000219513066],[17.14465810903056,48.15949715525821],[17.144767744118326,48.159371556944876],[17.144819383830736,48.15931326226922],[17.144908359680727,48.15921435529515],[17.144962730656147,48.15915246791201],[17.14505680107638,48.15904653956221],[17.145113976902337,48.15898206133198],[17.145456558139102,48.159123425269144],[17.145894595811285,48.15928018487426],[17.14659063202535,48.15955793056722],[17.14680763825737,48.159644556035715],[17.14745261034011,48.15989636603936],[17.147503460091883,48.159916086695716],[17.14775849720408,48.15999602100865],[17.148021023796332,48.16006964461539],[17.14822382544972,48.16011802721724],[17.14858162235919,48.16018500536677],[17.14887790079746,48.160240309448],[17.148879315014312,48.160239719852285],[17.14889699274039,48.16019090131775],[17.148905831609397,48.160167199547516],[17.148931817869567,48.15999692383002],[17.14897971240049,48.1596857967385],[17.149037841412365,48.159310550035485],[17.149074718964783,48.15908373292214],[17.14992915284475,48.159140437288784],[17.150644202126756,48.159188385784915],[17.15117111343855,48.15922340900846],[17.15205867460739,48.159277611566836],[17.152050549047914,48.15931430249924],[17.151990544914497,48.1596757901641],[17.15154176399588,48.15964326888303],[17.151476759517237,48.15968371200768],[17.15142300580834,48.16010106651109]],
    //vychod, astronomicka
    [[17.17705808018769,48.15878081933303],[17.176796030443626,48.1587606744971],[17.17658561131813,48.158745078489545],[17.176097555847377,48.15870803795221],[17.17511365161309,48.15863460662024],[17.174576888024518,48.15858846829926],[17.174176507189514,48.15855922568292],[17.173545249813372,48.15851373713491],[17.1734546526898,48.158508538440856],[17.172499973335675,48.15844030553038],[17.172486335059574,48.15844030553038],[17.171797602097996,48.158385069296145],[17.16837049804667,48.15813618059272],[17.166817682846414,48.15799971368938],[17.16650400248477,48.15799776415986],[17.16594970396858,48.15795617417305],[17.163757838090476,48.157789813901275],[17.16354081514686,48.1577540677217],[17.163363981632557,48.15772010882475],[17.163176430937312,48.15774155655177],[17.163104089953464,48.15772010882475],[17.163034428266485,48.157698661088716],[17.16283616038774,48.15768078796839],[17.16271827137942,48.157712959580266],[17.162627175326662,48.1576647021551],[17.162458379700325,48.15762001931341],[17.16201508707934,48.157709621970525],[17.161897071000283,48.1576987631465],[17.16186044532111,48.15769604844027],[17.160969220450966,48.157620036604925],[17.160057647980807,48.15756845708137],[17.15810834791742,48.157424577074295],[17.157721743521876,48.157400144582],[17.156793892971592,48.15732684703414],[17.156529374174852,48.15732956176052],[17.15649607538137,48.157518667441394],[17.15645692652967,48.15773380792294],[17.1564298929311,48.15792029783367],[17.15622317772167,48.15790296037471],[17.156056979735382,48.15788973805158],[17.15527463360084,48.15783049319057],[17.155256389544462,48.15790596912839],[17.155161264301256,48.158445213900535],[17.1550215282966,48.159323220350814],[17.15474056409971,48.159382855747396],[17.154384001256886,48.159591993578914],[17.1544014215161,48.1594557129678],[17.152057795478896,48.159277775885414],[17.15204949033881,48.15931347837949],[17.151991354362565,48.15967850417968],[17.15154103125414,48.15964341749077],[17.15147551293103,48.159684044175634],[17.1514229137328,48.160101389158996]],
  ]

  map.on('load', () => {
    map.addSource("safety", {
      type: "geojson",
      data: {
        type: "FeatureCollection",
        features: [
          turf.lineString(safetyRoutes[0]),
          turf.lineString(safetyRoutes[1]),
        ],
      },
    })

    map.addLayer({
      'id': 'safety',
      'type': 'line',
      'source': 'safety',
      'layout': {
        'line-cap': 'round',
        'line-join': 'round'
      },
      'paint': {
        'line-color': '#4ed54b',
        'line-width': 10,
        'line-opacity': 0.5
      }
    })
  })

  let useSafety = true

  map.on('click', (e) => {
    const source = [e.lngLat.lng, e.lngLat.lat]

    if (useSafety) {

      getDistances({source, routes: safetyRoutes}, (data) => {
  
        //console.log(data)
  
        let index = data.distances[0].indexOf(Math.min(...data.distances[0].slice(1)))


        //todo: find route from which index is
        let cursor = 1
        let route = safetyRoutes.map((route, index) => {
          let interval = [cursor, cursor+route.length, index]
          cursor += route.length
          return interval
        }).filter(interval => interval[0] < index && interval[1] > index)[0]

        index = index-route[0]
        customRoute = safetyRoutes[route[2]][index]
  
        let params = {
          coordinates: [
            source,
            customRoute
          ]
        }
  
        getDirections(params, (data) => {
          const coords = data.features[0].geometry.coordinates
          geojson.features[0].geometry.coordinates = [...coords, ...safetyRoutes[route[2]].slice(index)]
          map.getSource('route').setData(geojson)
        })
  
      })

    } else {
      let params = {
        coordinates: [
          source,
          destination
        ]
      }

      getDirections(params, (data) => {
        const coords = data.features[0].geometry.coordinates
        geojson.features[0].geometry.coordinates = coords
        map.getSource('route').setData(geojson)
      })
    }


  })


  function x(source, destination, safetyRoutes) {
    
  }

</script>
 
<script src="/js/draw.js"></script>
<script src="/js/lines.js"></script>
<script src="/js/directions.js"></script>

<script>
  
</script>

</body>
</html>